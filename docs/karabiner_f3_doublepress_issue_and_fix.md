# Karabiner-Elements：F3「1回押し」と「ダブル押し」競合の原因と解決（詳細）

作成日: 2025-12-30
対象: Karabiner-Elements complex modifications（`type: basic` / `to_delayed_action` / 変数条件）

---

## 1. 現象（何が起きていたか）

- **F3を1回押し** → 期待通り「Excel（.xlsm）を開く」
- **F3を2回押し（ダブル押し）** →
  **Ctrl+Shift+0 が送られる**（これは期待通り）**が、同時にExcelも開いてしまう**（これが問題）

---

## 2. 原因（なぜExcelが開いてしまうのか）

結論から言うと、**「1回押し側の処理が“待たずに即実行”されていた**」ためです。

### 2.1 旧構成のポイント
旧コードでは「1回押し」側の `to` に以下が入っていました：

- `set_variable`（`f3 pressed = 1`）
- `shell_command`（Excelを `open`）

つまり、**F3を押した瞬間にExcel起動コマンドが実行**されます。

### 2.2 Karabinerの評価順と“競合”のイメージ

ダブル押し判定は、一般的にこういう時間軸になります（概念図）：

1. **1回目のF3が押される**
2. 「これは1回押しかもしれない」→ **一旦、1回押し処理を予約 or 遅延させたい**
3. すぐに2回目が来るなら「ダブル押し」→ 1回押し処理をキャンセルしてダブル側を実行
4. 2回目が来ないなら「1回押し」→ 予約していた処理を確定実行

しかし旧コードは「2」をやらずに、**1回目の瞬間に（2回目が来るかどうかを待たずに）Excelを開いてしまう**ため、

- その後、2回目が来て「ダブル押し」条件が成立すると
- **ダブル押し側（Ctrl+Shift+0）も動く**
- でも **Excel起動は既に実行済み** → **Excelが開いてしまう**

となります。

> 重要: `to_delayed_action` があっても、**`to` の中に書いた処理は即実行**です。
> `to_delayed_action` が遅延できるのは、**そこに入れた処理だけ**です。

### 2.3 旧コードで `to_delayed_action` が効いていなかった理由
旧コードの `to_delayed_action` には「変数を 0 に戻す」しか入っていませんでした。

- `to`：Excelを開く（即実行）
- `to_delayed_action`：変数を戻す（遅延/キャンセルしてもExcelとは無関係）

つまり、ダブル押し時にキャンセルされても、キャンセルされるのは「変数リセット」だけで、
**Excel起動はキャンセル対象ではなかった**のが根本原因です。

---

## 3. 解決策（どう直したか）

### 3.1 修正の核心
**Excelを開く処理を `to_delayed_action.to_if_invoked` に移動**しました。

これにより：

- 1回目の押下時点では **Excelを開かない**
- 一定時間（例: 300ms）待っても2回目が来なければ **「1回押し確定」**としてExcel起動
- 2回目が来たら **「1回押し予約」をキャンセル**し、Excel起動は行われない

### 3.2 役割分担（ダブル側とシングル側）

#### ダブル押し側（条件：変数が 1）
- Ctrl+Shift+0 を送る
- ついでに変数を0へ戻す（次回のための後始末）

#### 1回押し側（条件：変数が 0）
- まず変数を 1 にする（「1回目が来た」印）
- Excel起動は **遅延実行**として予約
- ダブル押しが来たらキャンセル（Excel起動しない）
- どちらにせよ最後は変数を 0 に戻して状態をリセット

---

## 4. 実装のポイント（学びとして残す）

### 4.1 「即実行（to）」と「遅延確定（to_delayed_action）」の違い

- **`to`**：キーを押した瞬間に実行される（即時）
- **`to_delayed_action.to_if_invoked`**：一定時間経過後に「確定」したら実行される（遅延）
- **`to_delayed_action.to_if_canceled`**：その遅延処理がキャンセルされた時に実行される

> ダブル押しで「1回押しと排他」にしたい処理（今回なら Excel を開く）は、
> **必ず `to_delayed_action.to_if_invoked` 側へ入れる**のが定石です。

### 4.2 変数名にスペースは避ける（推奨）
今回 `f3 pressed` でも動くことは多いですが、
将来のメンテ性・タイポ事故・検索性を考えると

- `f3_pressed`
- `pressed_f3`
- `f3_press_state`

など **英数字 + underscore** が無難です。

### 4.3 遅延時間（delay）のチューニング目安
`basic.to_delayed_action_delay_milliseconds` は体感が大きいので調整します。

- **200ms**：反応は速いが、ダブル押しが遅い人だと1回押しが確定しやすい
- **250〜350ms（推奨）**：多くの人のダブル押しテンポに合いやすい
- **400ms以上**：誤判定は減るが、1回押しの確定が遅く感じやすい

---

## 5. 再発防止チェックリスト

1. **排他にしたい処理**（例：アプリ起動、ファイルオープン、ペーストなど）は
   ✅ `to_delayed_action.to_if_invoked` に入っているか
2. `to` の中に **重い処理（shell_commandなど）** を入れていないか
3. ダブル側で **状態（変数）を確実にリセット**しているか
4. `to_if_canceled` でも **変数を必ず初期化**しているか
5. 遅延時間が自分のダブル押し速度に合っているか

---

## 6. まとめ（今回の一言）

- 旧コードは **「1回押し処理が即実行」**だったため、ダブル押しでもExcelが開いた
- 解決は **Excel起動を遅延確定（to_delayed_action.to_if_invoked）へ移す**こと
- ダブル押しでキャンセルできるようにして、期待通りの排他動作になった

---

## 付録：改善後の設計パターン（テンプレ）

- 1回押し → `to`: 変数ON、`to_delayed_action.to_if_invoked`: 本命処理
- 2回押し → 条件（変数ON）で本命処理B、ついでに変数OFF
- `to_if_canceled` / `to_if_invoked` の両方で変数OFF（状態を必ず戻す）
